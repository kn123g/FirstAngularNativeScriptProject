import { Directive, Input, ElementRef, NgZone } from '@angular/core';
import { ActivatedRoute, Router } from '@angular/router';
import { NativeScriptDebug } from '../trace';
import { RouterExtensions } from './router-extensions';
import { Subject } from 'rxjs';
/**
 * The nsRouterLink directive lets you link to specific parts of your app.
 *
 * Consider the following route configuration:
 * ```
 * [{ path: "/user", component: UserCmp }]
 * ```
 *
 * When linking to this `User` route, you can write:
 *
 * ```
 * <a [nsRouterLink]="["/user"]">link to user component</a>
 * ```
 *
 * NSRouterLink expects the value to be an array of path segments, followed by the params
 * for that level of routing. For instance `["/team", {teamId: 1}, "user", {userId: 2}]`
 * means that we want to generate a link to `/team;teamId=1/user;userId=2`.
 *
 * The first segment name can be prepended with `/`, `./`, or `../`.
 * If the segment begins with `/`, the router will look up the route from the root of the app.
 * If the segment begins with `./`, or doesn"t begin with a slash, the router will
 * instead look in the current component"s children for the route.
 * And if the segment begins with `../`, the router will go up one level.
 */
export class NSRouterLink {
    constructor(ngZone, router, navigator, route, el) {
        this.ngZone = ngZone;
        this.router = router;
        this.navigator = navigator;
        this.route = route;
        this.el = el;
        this.pageTransition = true;
        /** @internal */
        this.onChanges = new Subject();
        this.commands = [];
    }
    ngAfterViewInit() {
        this.el.nativeElement.on('tap', () => {
            this.ngZone.run(() => {
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog(`nsRouterLink.tapped: ${this.commands} ` + `clear: ${this.clearHistory} ` + `transition: ${JSON.stringify(this.pageTransition)} ` + `duration: ${this.pageTransitionDuration}`);
                }
                const extras = this.getExtras();
                // this.navigator.navigateByUrl(this.urlTree, extras);
                this.navigator.navigate(this.commands, Object.assign(Object.assign({}, extras), { relativeTo: this.route, queryParams: this.queryParams, fragment: this.fragment, queryParamsHandling: this.queryParamsHandling, preserveFragment: attrBoolValue(this.preserveFragment) }));
            });
        });
    }
    ngOnChanges(changes) {
        // This is subscribed to by `RouterLinkActive` so that it knows to update when there are changes
        // to the RouterLinks it's tracking.
        this.onChanges.next(this);
    }
    set params(data) {
        if (Array.isArray(data)) {
            this.commands = data;
        }
        else {
            this.commands = [data];
        }
    }
    getExtras() {
        const transition = this.getTransition();
        return {
            skipLocationChange: attrBoolValue(this.skipLocationChange),
            replaceUrl: attrBoolValue(this.replaceUrl),
            clearHistory: this.convertClearHistory(this.clearHistory),
            animated: transition.animated,
            transition: transition.transition,
        };
    }
    get urlTree() {
        const urlTree = this.router.createUrlTree(this.commands, {
            relativeTo: this.route,
            queryParams: this.queryParams,
            fragment: this.fragment,
            queryParamsHandling: this.queryParamsHandling,
            preserveFragment: attrBoolValue(this.preserveFragment),
        });
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`nsRouterLink urlTree created: ${urlTree}`);
        }
        return urlTree;
    }
    convertClearHistory(value) {
        return value === true || value === 'true';
    }
    getTransition() {
        let transition;
        let animated;
        if (typeof this.pageTransition === 'boolean') {
            animated = this.pageTransition;
        }
        else if (typeof this.pageTransition === 'string') {
            if (this.pageTransition === 'none' || this.pageTransition === 'false') {
                animated = false;
            }
            else {
                animated = true;
                transition = {
                    name: this.pageTransition,
                };
            }
        }
        else {
            animated = true;
            transition = this.pageTransition;
        }
        let duration = +this.pageTransitionDuration;
        if (!isNaN(duration)) {
            transition = transition || {};
            transition.duration = duration;
        }
        return { animated, transition };
    }
}
NSRouterLink.decorators = [
    { type: Directive, args: [{ selector: '[nsRouterLink]' },] }
];
NSRouterLink.ctorParameters = () => [
    { type: NgZone },
    { type: Router },
    { type: RouterExtensions },
    { type: ActivatedRoute },
    { type: ElementRef }
];
NSRouterLink.propDecorators = {
    target: [{ type: Input }],
    queryParams: [{ type: Input }],
    fragment: [{ type: Input }],
    queryParamsHandling: [{ type: Input }],
    preserveQueryParams: [{ type: Input }],
    preserveFragment: [{ type: Input }],
    skipLocationChange: [{ type: Input }],
    replaceUrl: [{ type: Input }],
    clearHistory: [{ type: Input }],
    pageTransition: [{ type: Input }],
    pageTransitionDuration: [{ type: Input }],
    params: [{ type: Input, args: ['nsRouterLink',] }]
};
function attrBoolValue(s) {
    return s === '' || !!s;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnMtcm91dGVyLWxpbmsuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9yb3V0ZXIvbnMtcm91dGVyLWxpbmsudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBNEIsTUFBTSxlQUFlLENBQUM7QUFFL0YsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLEVBQVcsTUFBTSxpQkFBaUIsQ0FBQztBQUVsRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDN0MsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFdkQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUsvQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F1Qkc7QUFFSCxNQUFNLE9BQU8sWUFBWTtJQXFCeEIsWUFBb0IsTUFBYyxFQUFVLE1BQWMsRUFBVSxTQUEyQixFQUFVLEtBQXFCLEVBQVUsRUFBYztRQUFsSSxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBZ0I7UUFBVSxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBUjdJLG1CQUFjLEdBQTRDLElBQUksQ0FBQztRQUd4RSxnQkFBZ0I7UUFDaEIsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFnQixDQUFDO1FBRWhDLGFBQVEsR0FBVSxFQUFFLENBQUM7SUFFNEgsQ0FBQztJQUUxSixlQUFlO1FBQ2QsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUU7WUFDcEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFO2dCQUNwQixJQUFJLGlCQUFpQixDQUFDLFlBQVksRUFBRSxFQUFFO29C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cHV0LCBFbGVtZW50UmVmLCBOZ1pvbmUsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTmF2aWdhdGlvbkV4dHJhcyB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgUm91dGVyLCBVcmxUcmVlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE5hdmlnYXRpb25UcmFuc2l0aW9uIH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi4vdHJhY2UnO1xuaW1wb3J0IHsgUm91dGVyRXh0ZW5zaW9ucyB9IGZyb20gJy4vcm91dGVyLWV4dGVuc2lvbnMnO1xuaW1wb3J0IHsgTmF2aWdhdGlvbk9wdGlvbnMgfSBmcm9tICcuL25zLWxvY2F0aW9uLXV0aWxzJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuLy8gQ29waWVkIGZyb20gXCJAYW5ndWxhci9yb3V0ZXIvc3JjL2NvbmZpZ1wiXG5leHBvcnQgdHlwZSBRdWVyeVBhcmFtc0hhbmRsaW5nID0gJ21lcmdlJyB8ICdwcmVzZXJ2ZScgfCAnJztcblxuLyoqXG4gKiBUaGUgbnNSb3V0ZXJMaW5rIGRpcmVjdGl2ZSBsZXRzIHlvdSBsaW5rIHRvIHNwZWNpZmljIHBhcnRzIG9mIHlvdXIgYXBwLlxuICpcbiAqIENvbnNpZGVyIHRoZSBmb2xsb3dpbmcgcm91dGUgY29uZmlndXJhdGlvbjpcbiAqIGBgYFxuICogW3sgcGF0aDogXCIvdXNlclwiLCBjb21wb25lbnQ6IFVzZXJDbXAgfV1cbiAqIGBgYFxuICpcbiAqIFdoZW4gbGlua2luZyB0byB0aGlzIGBVc2VyYCByb3V0ZSwgeW91IGNhbiB3cml0ZTpcbiAqXG4gKiBgYGBcbiAqIDxhIFtuc1JvdXRlckxpbmtdPVwiW1wiL3VzZXJcIl1cIj5saW5rIHRvIHVzZXIgY29tcG9uZW50PC9hPlxuICogYGBgXG4gKlxuICogTlNSb3V0ZXJMaW5rIGV4cGVjdHMgdGhlIHZhbHVlIHRvIGJlIGFuIGFycmF5IG9mIHBhdGggc2VnbWVudHMsIGZvbGxvd2VkIGJ5IHRoZSBwYXJhbXNcbiAqIGZvciB0aGF0IGxldmVsIG9mIHJvdXRpbmcuIEZvciBpbnN0YW5jZSBgW1wiL3RlYW1cIiwge3RlYW1JZDogMX0sIFwidXNlclwiLCB7dXNlcklkOiAyfV1gXG4gKiBtZWFucyB0aGF0IHdlIHdhbnQgdG8gZ2VuZXJhdGUgYSBsaW5rIHRvIGAvdGVhbTt0ZWFtSWQ9MS91c2VyO3VzZXJJZD0yYC5cbiAqXG4gKiBUaGUgZmlyc3Qgc2VnbWVudCBuYW1lIGNhbiBiZSBwcmVwZW5kZWQgd2l0aCBgL2AsIGAuL2AsIG9yIGAuLi9gLlxuICogSWYgdGhlIHNlZ21lbnQgYmVnaW5zIHdpdGggYC9gLCB0aGUgcm91dGVyIHdpbGwgbG9vayB1cCB0aGUgcm91dGUgZnJvbSB0aGUgcm9vdCBvZiB0aGUgYXBwLlxuICogSWYgdGhlIHNlZ21lbnQgYmVnaW5zIHdpdGggYC4vYCwgb3IgZG9lc25cInQgYmVnaW4gd2l0aCBhIHNsYXNoLCB0aGUgcm91dGVyIHdpbGxcbiAqIGluc3RlYWQgbG9vayBpbiB0aGUgY3VycmVudCBjb21wb25lbnRcInMgY2hpbGRyZW4gZm9yIHRoZSByb3V0ZS5cbiAqIEFuZCBpZiB0aGUgc2VnbWVudCBiZWdpbnMgd2l0aCBgLi4vYCwgdGhlIHJvdXRlciB3aWxsIGdvIHVwIG9uZSBsZXZlbC5cbiAqL1xuQERpcmVjdGl2ZSh7IHNlbGVjdG9yOiAnW25zUm91dGVyTGlua10nIH0pXG5leHBvcnQgY2xhc3MgTlNSb3V0ZXJMaW5rIGltcGxlbWVudHMgT25DaGFuZ2VzIHtcblx0Ly8gdHNsaW50OmRpc2FibGUtbGluZTpkaXJlY3RpdmUtY2xhc3Mtc3VmZml4XG5cdEBJbnB1dCgpIHRhcmdldDogc3RyaW5nO1xuXHRASW5wdXQoKSBxdWVyeVBhcmFtczogeyBbazogc3RyaW5nXTogYW55IH07XG5cdEBJbnB1dCgpIGZyYWdtZW50OiBzdHJpbmc7XG5cblx0QElucHV0KCkgcXVlcnlQYXJhbXNIYW5kbGluZzogUXVlcnlQYXJhbXNIYW5kbGluZztcblx0QElucHV0KCkgcHJlc2VydmVRdWVyeVBhcmFtczogYm9vbGVhbjtcblx0QElucHV0KCkgcHJlc2VydmVGcmFnbWVudDogYm9vbGVhbjtcblx0QElucHV0KCkgc2tpcExvY2F0aW9uQ2hhbmdlOiBib29sZWFuO1xuXHRASW5wdXQoKSByZXBsYWNlVXJsOiBib29sZWFuO1xuXG5cdEBJbnB1dCgpIGNsZWFySGlzdG9yeTogYm9vbGVhbjtcblx0QElucHV0KCkgcGFnZVRyYW5zaXRpb246IGJvb2xlYW4gfCBzdHJpbmcgfCBOYXZpZ2F0aW9uVHJhbnNpdGlvbiA9IHRydWU7XG5cdEBJbnB1dCgpIHBhZ2VUcmFuc2l0aW9uRHVyYXRpb247XG5cblx0LyoqIEBpbnRlcm5hbCAqL1xuXHRvbkNoYW5nZXMgPSBuZXcgU3ViamVjdDxOU1JvdXRlckxpbms+KCk7XG5cblx0cHJpdmF0ZSBjb21tYW5kczogYW55W10gPSBbXTtcblxuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIG5nWm9uZTogTmdab25lLCBwcml2YXRlIHJvdXRlcjogUm91dGVyLCBwcml2YXRlIG5hdmlnYXRvcjogUm91dGVyRXh0ZW5zaW9ucywgcHJpdmF0ZSByb3V0ZTogQWN0aXZhdGVkUm91dGUsIHByaXZhdGUgZWw6IEVsZW1lbnRSZWYpIHt9XG5cblx0bmdBZnRlclZpZXdJbml0KCkge1xuXHRcdHRoaXMuZWwubmF0aXZlRWxlbWVudC5vbigndGFwJywgKCkgPT4ge1xuXHRcdFx0dGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcblx0XHRcdFx0aWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG5cdFx0XHRcdFx0TmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBuc1JvdXRlckxpbmsudGFwcGVkOiAke3RoaXMuY29tbWFuZHN9IGAgKyBgY2xlYXI6ICR7dGhpcy5jbGVhckhpc3Rvcnl9IGAgKyBgdHJhbnNpdGlvbjogJHtKU09OLnN0cmluZ2lmeSh0aGlzLnBhZ2VUcmFuc2l0aW9uKX0gYCArIGBkdXJhdGlvbjogJHt0aGlzLnBhZ2VUcmFuc2l0aW9uRHVyYXRpb259YCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRjb25zdCBleHRyYXMgPSB0aGlzLmdldEV4dHJhcygpO1xuXHRcdFx0XHQvLyB0aGlzLm5hdmlnYXRvci5uYXZpZ2F0ZUJ5VXJsKHRoaXMudXJsVHJlZSwgZXh0cmFzKTtcblx0XHRcdFx0dGhpcy5uYXZpZ2F0b3IubmF2aWdhdGUodGhpcy5jb21tYW5kcywge1xuXHRcdFx0XHRcdC4uLmV4dHJhcyxcblx0XHRcdFx0XHRyZWxhdGl2ZVRvOiB0aGlzLnJvdXRlLFxuXHRcdFx0XHRcdHF1ZXJ5UGFyYW1zOiB0aGlzLnF1ZXJ5UGFyYW1zLFxuXHRcdFx0XHRcdGZyYWdtZW50OiB0aGlzLmZyYWdtZW50LFxuXHRcdFx0XHRcdHF1ZXJ5UGFyYW1zSGFuZGxpbmc6IHRoaXMucXVlcnlQYXJhbXNIYW5kbGluZyxcblx0XHRcdFx0XHRwcmVzZXJ2ZUZyYWdtZW50OiBhdHRyQm9vbFZhbHVlKHRoaXMucHJlc2VydmVGcmFnbWVudCksXG5cdFx0XHRcdH0pO1xuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdH1cblxuXHRuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG5cdFx0Ly8gVGhpcyBpcyBzdWJzY3JpYmVkIHRvIGJ5IGBSb3V0ZXJMaW5rQWN0aXZlYCBzbyB0aGF0IGl0IGtub3dzIHRvIHVwZGF0ZSB3aGVuIHRoZXJlIGFyZSBjaGFuZ2VzXG5cdFx0Ly8gdG8gdGhlIFJvdXRlckxpbmtzIGl0J3MgdHJhY2tpbmcuXG5cdFx0dGhpcy5vbkNoYW5nZXMubmV4dCh0aGlzKTtcblx0fVxuXG5cdEBJbnB1dCgnbnNSb3V0ZXJMaW5rJylcblx0c2V0IHBhcmFtcyhkYXRhOiBhbnlbXSB8IHN0cmluZykge1xuXHRcdGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XG5cdFx0XHR0aGlzLmNvbW1hbmRzID0gZGF0YTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5jb21tYW5kcyA9IFtkYXRhXTtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGdldEV4dHJhcygpOiBOYXZpZ2F0aW9uRXh0cmFzICYgTmF2aWdhdGlvbk9wdGlvbnMge1xuXHRcdGNvbnN0IHRyYW5zaXRpb24gPSB0aGlzLmdldFRyYW5zaXRpb24oKTtcblx0XHRyZXR1cm4ge1xuXHRcdFx0c2tpcExvY2F0aW9uQ2hhbmdlOiBhdHRyQm9vbFZhbHVlKHRoaXMuc2tpcExvY2F0aW9uQ2hhbmdlKSxcblx0XHRcdHJlcGxhY2VVcmw6IGF0dHJCb29sVmFsdWUodGhpcy5yZXBsYWNlVXJsKSxcblxuXHRcdFx0Y2xlYXJIaXN0b3J5OiB0aGlzLmNvbnZlcnRDbGVhckhpc3RvcnkodGhpcy5jbGVhckhpc3RvcnkpLFxuXHRcdFx0YW5pbWF0ZWQ6IHRyYW5zaXRpb24uYW5pbWF0ZWQsXG5cdFx0XHR0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLnRyYW5zaXRpb24sXG5cdFx0fTtcblx0fVxuXG5cdGdldCB1cmxUcmVlKCk6IFVybFRyZWUge1xuXHRcdGNvbnN0IHVybFRyZWUgPSB0aGlzLnJvdXRlci5jcmVhdGVVcmxUcmVlKHRoaXMuY29tbWFuZHMsIHtcblx0XHRcdHJlbGF0aXZlVG86IHRoaXMucm91dGUsXG5cdFx0XHRxdWVyeVBhcmFtczogdGhpcy5xdWVyeVBhcmFtcyxcblx0XHRcdGZyYWdtZW50OiB0aGlzLmZyYWdtZW50LFxuXHRcdFx0cXVlcnlQYXJhbXNIYW5kbGluZzogdGhpcy5xdWVyeVBhcmFtc0hhbmRsaW5nLFxuXHRcdFx0cHJlc2VydmVGcmFnbWVudDogYXR0ckJvb2xWYWx1ZSh0aGlzLnByZXNlcnZlRnJhZ21lbnQpLFxuXHRcdH0pO1xuXG5cdFx0aWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG5cdFx0XHROYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coYG5zUm91dGVyTGluayB1cmxUcmVlIGNyZWF0ZWQ6ICR7dXJsVHJlZX1gKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdXJsVHJlZTtcblx0fVxuXG5cdHByaXZhdGUgY29udmVydENsZWFySGlzdG9yeSh2YWx1ZTogYm9vbGVhbiB8IHN0cmluZyk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiB2YWx1ZSA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gJ3RydWUnO1xuXHR9XG5cblx0cHJpdmF0ZSBnZXRUcmFuc2l0aW9uKCk6IHsgYW5pbWF0ZWQ6IGJvb2xlYW47IHRyYW5zaXRpb24/OiBOYXZpZ2F0aW9uVHJhbnNpdGlvbiB9IHtcblx0XHRsZXQgdHJhbnNpdGlvbjogTmF2aWdhdGlvblRyYW5zaXRpb247XG5cdFx0bGV0IGFuaW1hdGVkOiBib29sZWFuO1xuXG5cdFx0aWYgKHR5cGVvZiB0aGlzLnBhZ2VUcmFuc2l0aW9uID09PSAnYm9vbGVhbicpIHtcblx0XHRcdGFuaW1hdGVkID0gdGhpcy5wYWdlVHJhbnNpdGlvbjtcblx0XHR9IGVsc2UgaWYgKHR5cGVvZiB0aGlzLnBhZ2VUcmFuc2l0aW9uID09PSAnc3RyaW5nJykge1xuXHRcdFx0aWYgKHRoaXMucGFnZVRyYW5zaXRpb24gPT09ICdub25lJyB8fCB0aGlzLnBhZ2VUcmFuc2l0aW9uID09PSAnZmFsc2UnKSB7XG5cdFx0XHRcdGFuaW1hdGVkID0gZmFsc2U7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRhbmltYXRlZCA9IHRydWU7XG5cdFx0XHRcdHRyYW5zaXRpb24gPSB7XG5cdFx0XHRcdFx0bmFtZTogPHN0cmluZz50aGlzLnBhZ2VUcmFuc2l0aW9uLFxuXHRcdFx0XHR9O1xuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRhbmltYXRlZCA9IHRydWU7XG5cdFx0XHR0cmFuc2l0aW9uID0gPE5hdmlnYXRpb25UcmFuc2l0aW9uPnRoaXMucGFnZVRyYW5zaXRpb247XG5cdFx0fVxuXG5cdFx0bGV0IGR1cmF0aW9uID0gK3RoaXMucGFnZVRyYW5zaXRpb25EdXJhdGlvbjtcblx0XHRpZiAoIWlzTmFOKGR1cmF0aW9uKSkge1xuXHRcdFx0dHJhbnNpdGlvbiA9IHRyYW5zaXRpb24gfHwge307XG5cdFx0XHR0cmFuc2l0aW9uLmR1cmF0aW9uID0gZHVyYXRpb247XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHsgYW5pbWF0ZWQsIHRyYW5zaXRpb24gfTtcblx0fVxufVxuXG5mdW5jdGlvbiBhdHRyQm9vbFZhbHVlKHM6IGFueSk6IGJvb2xlYW4ge1xuXHRyZXR1cm4gcyA9PT0gJycgfHwgISFzO1xufVxuIl19